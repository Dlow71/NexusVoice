# NexusVoice 运行指南

## 概述

NexusVoice 是一个完整的智能语音对话系统，包含：
- **Backend**：基于 Spring Boot 3 和 Java 21 的后端服务，集成了 AI 聊天、TTS 语音合成、图像生成、文件上传等功能
- **Frontend**：基于 Vue 3 + Vite 的现代化前端应用，提供用户友好的聊天界面

## 系统要求

### 后端环境依赖
- **JDK 21+** - 必需
- **Maven 3.9+** - 构建工具
- **MySQL 8.0+** - 数据库
- **Git** - 版本控制

### 前端环境依赖
- **Node.js 22+** - JavaScript 运行时
- **npm 或 yarn** - 包管理器

### 外部服务依赖
- **OpenAI API** - AI 聊天功能
- **七牛云存储** - 文件上传和 TTS 服务
- **硅基流动 API** - 图像生成（可选）
- **Tavily API** - 联网搜索（可选）

## 快速开始

### 1. 克隆项目

```bash
git clone <repository-url>
cd NexusVoice
```

### 2. 后端环境配置

#### 2.1 进入后端目录

```bash
cd nexusvoice-backend
```

#### 2.2 复制配置文件模板

```bash
cp src/main/resources/application-local.yml.example src/main/resources/application-local.yml
```

#### 2.3 配置数据库

编辑 `src/main/resources/application-local.yml` 文件，配置数据库连接：

```yaml
spring:
  datasource:
    # MySQL数据库连接信息 - 请根据实际情况修改
    url: jdbc:mysql://localhost:3306/nexusvoice_dev?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
    username: your_mysql_username
    password: your_mysql_password
    druid:
      # Druid监控页面登录信息 - 请修改为安全的用户名和密码
      stat-view-servlet:
        login-username: your_admin_username
        login-password: your_admin_password
```

#### 2.4 配置 JWT 密钥

生成一个安全的 JWT 密钥（建议 64 位以上随机字符串）：

```yaml
jwt:
  # JWT密钥 - 请生成一个安全的密钥（建议64位以上随机字符串）
  secret: your-jwt-secret-key-here-please-change-this-to-a-secure-random-string-at-least-64-chars
  # 访问令牌过期时间（毫秒）- 24小时
  expiration: 86400000
  # 刷新令牌过期时间（毫秒）- 7天  
  refresh-expiration: 604800000
  # JWT签发者
  issuer: nexusvoice-local
```

#### 2.5 配置 AI 服务

配置 OpenAI API：

```yaml
langchain4j:
  enabled: true
  open-ai:
    # OpenAI API配置 - 请填入您的API密钥
    api-key: sk-your-openai-api-key-here
    base-url: https://api.openai.com/v1
    chat-model:
      model-name: gpt-4o-mini
      temperature: 0.7
      max-tokens: 2000
    embedding-model:
      model-name: text-embedding-3-small
```

#### 2.6 配置文件上传服务

配置七牛云存储：

```yaml
fast-alden:
  file:
    oss:
      qiniu:
        # 七牛云存储配置
        access-key: your-qiniu-access-key
        secret-key: your-qiniu-secret-key
        bucket: your-bucket-name
        domain: https://your-domain.com
        # 按文件类型分目录存储
        directories:
          audio: "audio/"
          image: "images/"
          video: "videos/"
          document: "docs/"
          other: "files/"
```

#### 2.7 配置 TTS 服务

配置七牛云 TTS：

```yaml
nexusvoice:
  tts:
    # 七牛云TTS API Token - 请填入你的实际token
    token: your-qiniu-tts-token-here
    # 默认音色（可选配置）
    voice-type: qiniu_zh_female_wwxkjx
    # 默认编码格式（可选配置）
    encoding: mp3
    # 默认语速比例（可选配置）
    speed-ratio: 1.0
    # 连接超时时间（秒）（可选配置）
    timeout-seconds: 30
```

#### 2.8 配置图像生成服务（可选）

配置硅基流动 API：

```yaml
nexusvoice:
  image:
    siliconflow:
      # 硅基流动API密钥 - 请填入你的实际API密钥
      api-key: sk-your-siliconflow-api-key-here
      # API基础URL（可选，默认使用官方地址）
      base-url: https://api.siliconflow.cn/v1
    enabled: true
```

#### 2.9 配置联网搜索服务（可选）

配置 Tavily 搜索：

```yaml
nexusvoice:
  search:
    # 搜索提供商：duckduckgo, tavily
    provider: tavily
    tavily:
      # Tavily API密钥 - 请填入你的实际API密钥
      api-key: tvly-your-actual-api-key-here
```

### 3. 前端环境配置

#### 3.1 进入前端目录

```bash
# 从项目根目录进入前端目录
cd nexus-voice-frontend
```

#### 3.2 安装依赖

```bash
# 使用 npm 安装依赖
npm install

# 或使用 yarn
yarn install
```

#### 3.3 配置后端 API 地址

编辑 `src/services/api.js` 文件，确认后端 API 地址配置正确：

```javascript
const apiClient = axios.create({
    // 后端服务地址，确保与后端服务端口一致
    baseURL: "http://localhost:8081/api",
    timeout: 30000,
});
```

**注意**：
- 默认后端服务运行在 `http://localhost:8081`
- 如果后端服务端口不同，请相应修改 `baseURL`
- 生产环境需要修改为实际的后端服务地址

#### 3.4 开发环境跨域配置（可选）

如果需要在开发环境处理跨域问题，可以编辑 `vite.config.js` 文件：

```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  server: {
    proxy: {
      '/api': {
        // 开发环境下处理跨域问题
        target: 'http://localhost:8081',
        changeOrigin: true,
        rewrite: (path) => path
      }
    }
  },
  plugins: [vue()],
})
```

### 4. 数据库初始化

#### 4.1 创建数据库

```sql
CREATE DATABASE nexusvoice_dev CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 4.2 数据库迁移

项目使用 Flyway 进行数据库版本管理，启动时会自动执行迁移脚本。

迁移脚本位置：`src/main/resources/db/migration/`

### 5. 构建和运行

## 5.1 后端服务运行

#### 5.1.1 使用 Maven 运行

确保在 `nexusvoice-backend` 目录下：

```bash
# 清理并编译
mvn clean compile

# 运行应用（开发环境）
mvn spring-boot:run

# 或者指定 profile
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

#### 5.1.2 打包运行

```bash
# 打包
mvn clean package -DskipTests

# 运行 JAR 文件
java -jar target/nexusvoice-backend-0.0.1-SNAPSHOT.jar

# 指定 profile
java -jar target/nexusvoice-backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev
```

#### 5.1.3 使用 Docker 运行

```bash
# 构建 Docker 镜像
docker build -t nexusvoice-backend .

# 运行容器
docker run -p 8081:8081 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e DB_URL=jdbc:mysql://host.docker.internal:3306/nexusvoice_prod \
  -e DB_USERNAME=your_username \
  -e DB_PASSWORD=your_password \
  -e JWT_SECRET=your_jwt_secret \
  nexusvoice-backend
```

## 5.2 前端应用运行

#### 5.2.1 开发环境运行

确保在 `nexus-voice-frontend` 目录下：

```bash
# 启动开发服务器
npm run dev

# 或使用 yarn
yarn dev
```

默认情况下，前端应用将运行在 `http://localhost:5173`

#### 5.2.2 生产环境构建

```bash
# 构建生产版本
npm run build

# 或使用 yarn
yarn build
```

构建完成后，生成的文件将位于 `dist/` 目录。

#### 5.2.3 预览生产构建

```bash
# 预览生产构建
npm run preview

# 或使用 yarn
yarn preview
```

#### 5.2.4 使用 Docker 运行前端（可选）

创建 `nexus-voice-frontend/Dockerfile`：

```dockerfile
# 构建阶段
FROM node:18-alpine as build-stage
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# 生产阶段
FROM nginx:alpine as production-stage
COPY --from=build-stage /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

构建并运行：

```bash
# 构建前端镜像
docker build -t nexusvoice-frontend .

# 运行前端容器
docker run -p 80:80 nexusvoice-frontend
```

### 6. 验证启动

#### 6.1 后端服务验证

访问健康检查端点：

```bash
curl http://localhost:8081/api/health
```

预期响应：
```json
{
  "code": 200,
  "message": "success",
  "data": "Service is running"
}
```

#### 6.2 API 文档

访问 Swagger UI：

```
http://localhost:8081/swagger-ui.html
```

#### 6.3 数据库监控

访问 Druid 监控页面：

```
http://localhost:8081/druid/index.html
```

使用在 `application-local.yml` 中配置的用户名和密码登录。

## 生产环境部署

### 环境变量配置

生产环境建议使用环境变量配置敏感信息：

```bash
export DB_URL="jdbc:mysql://prod-db:3306/nexusvoice_prod"
export DB_USERNAME="nexusvoice"
export DB_PASSWORD="your_secure_password"
export JWT_SECRET="your_very_secure_jwt_secret_key_at_least_64_characters_long"
export OPENAI_API_KEY="sk-your-production-openai-key"
export QINIU_ACCESS_KEY="your_qiniu_access_key"
export QINIU_SECRET_KEY="your_qiniu_secret_key"
export TTS_TOKEN="your_qiniu_tts_token"
```

### 性能优化

#### JVM 参数
```bash
java -Xms2g -Xmx4g -XX:+UseG1GC \
  -XX:+UseStringDeduplication \
  -XX:MaxGCPauseMillis=200 \
  -jar nexusvoice-backend.jar
```

#### 数据库连接池
在生产环境配置中调整连接池参数：

```yaml
spring:
  datasource:
    druid:
      initial-size: 10
      min-idle: 10
      max-active: 50
      max-wait: 60000
```

## 故障排除

### 常见问题

#### 1. 启动失败 - 数据库连接错误
**错误信息**：`Communications link failure`

**解决方案**：
- 检查数据库服务是否启动
- 验证数据库连接信息是否正确
- 确认防火墙设置允许数据库端口访问

#### 2. JWT 相关错误
**错误信息**：`JWT signature does not match`

**解决方案**：
- 确保 JWT 密钥配置正确且足够长（建议 64 位以上）
- 检查系统时间是否同步

#### 3. AI 服务调用失败
**错误信息**：`OpenAI API call failed`

**解决方案**：
- 验证 OpenAI API 密钥是否有效
- 检查网络连接和代理设置
- 确认 API 配额是否充足

#### 4. TTS 服务错误
**错误信息**：`TTS conversion failed`

**解决方案**：
- 检查七牛云 TTS Token 是否有效
- 验证网络连接
- 确认 TTS 服务配额

### 日志配置

#### 开发环境日志
```yaml
logging:
  level:
    root: INFO
    com.nexusvoice: DEBUG
    org.springframework.web: DEBUG
```

#### 生产环境日志
```yaml
logging:
  level:
    root: WARN
    com.nexusvoice: INFO
  file:
    name: logs/nexusvoice.log
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30
```

## 配置文件详解

### application-local.yml.example

这是本地开发环境的配置模板文件，包含以下主要配置项：

1. **数据库配置**：MySQL 连接信息和 Druid 连接池配置
2. **JWT 配置**：身份认证相关配置
3. **LangChain4j 配置**：OpenAI API 集成配置
4. **文件上传配置**：七牛云存储配置
5. **TTS 配置**：语音合成服务配置
6. **图像生成配置**：AI 图像生成服务配置
7. **搜索服务配置**：联网搜索功能配置

**重要提示**：
- 此文件包含敏感信息模板，不会被提交到 Git
- 开发者需要复制为 `application-local.yml` 并填入真实配置
- 所有 API 密钥和密码都需要替换为实际值

### 完整配置文件内容

以下是 `src/main/resources/application-local.yml.example` 的完整内容：

```yaml
# 本地开发环境配置文件模板
# 复制此文件为 application-local.yml 并填入实际的配置信息
# 注意：application-local.yml 文件不会被提交到Git
# 
# 重要说明：
# 在Spring Boot 3.x中，不能在profile特定的配置文件中使用spring.profiles.include
# 此文件将作为local profile的配置，通过application.yml中的spring.profiles.include引入

# 本地开发环境数据库配置
spring:
  datasource:
    # MySQL数据库连接信息 - 请根据实际情况修改
    url: jdbc:mysql://localhost:3306/nexusvoice_dev?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
    username: your_mysql_username
    password: your_mysql_password
    druid:
      # Druid监控页面登录信息 - 请修改为安全的用户名和密码
      stat-view-servlet:
        login-username: your_admin_username
        login-password: your_admin_password

# JWT本地开发配置
jwt:
  # JWT密钥 - 请生成一个安全的密钥（建议64位以上随机字符串）
  secret: your-jwt-secret-key-here-please-change-this-to-a-secure-random-string-at-least-64-chars
  # 访问令牌过期时间（毫秒）- 24小时
  expiration: 86400000
  # 刷新令牌过期时间（毫秒）- 7天  
  refresh-expiration: 604800000
  # JWT签发者
  issuer: nexusvoice-local

# LangChain4j配置
langchain4j:
  # 启用LangChain4j功能
  enabled: true
  open-ai:
    # OpenAI API配置 - 请填入您的API密钥
    api-key: sk-your-openai-api-key-here
    base-url: https://api.openai.com/v1
    # 聊天模型配置
    chat-model:
      model-name: gpt-4o-mini
      temperature: 0.7
      max-tokens: 2000
    # 嵌入模型配置（为将来RAG功能预留）
    embedding-model:
      model-name: text-embedding-3-small

# Fast-Alden配置（文件上传等服务）
fast-alden:
  file:
    oss:
      qiniu:
        # 七牛云存储配置
        access-key: your-qiniu-access-key
        secret-key: your-qiniu-secret-key
        bucket: your-bucket-name
        domain: https://your-domain.com
        # 按文件类型分目录存储
        directories:
          audio: "audio/"
          image: "images/"
          video: "videos/"
          document: "docs/"
          other: "files/"

# NexusVoice配置
nexusvoice:
  # 搜索服务配置
  search:
    # 搜索提供商：duckduckgo, tavily
    provider: tavily
    # Tavily搜索API配置
    tavily:
      # Tavily API密钥 - 请填入你的实际API密钥
      api-key: tvly-your-actual-api-key-here
  # TTS文本转语音配置
  tts:
    # 七牛云TTS API Token - 请填入你的实际token
    token: your-qiniu-tts-token-here
    # 默认音色（可选配置）
    voice-type: qiniu_zh_female_wwxkjx
    # 默认编码格式（可选配置）
    encoding: mp3
    # 默认语速比例（可选配置）
    speed-ratio: 1.0
    # 连接超时时间（秒）（可选配置）
    timeout-seconds: 30
  # 图像生成服务配置
  image:
    # 硅基流动API配置
    siliconflow:
      # 硅基流动API密钥 - 请填入你的实际API密钥
      api-key: sk-your-siliconflow-api-key-here
      # API基础URL（可选，默认使用官方地址）
      base-url: https://api.siliconflow.cn/v1
    # 服务启用状态（可选配置）
    enabled: true

# 第三方API密钥示例
# third-party:
#   some-service:
#     api-key: your-api-key
#     secret-key: your-secret-key
```

### 配置项说明

#### 数据库配置
- `spring.datasource.url`: MySQL 数据库连接地址
- `spring.datasource.username/password`: 数据库用户名和密码
- `spring.datasource.druid.stat-view-servlet`: Druid 监控页面登录信息

#### JWT 配置
- `jwt.secret`: JWT 签名密钥，建议使用 64 位以上随机字符串
- `jwt.expiration`: 访问令牌过期时间（毫秒）
- `jwt.refresh-expiration`: 刷新令牌过期时间（毫秒）

#### AI 服务配置
- `langchain4j.open-ai.api-key`: OpenAI API 密钥
- `langchain4j.open-ai.chat-model`: 聊天模型配置
- `langchain4j.open-ai.embedding-model`: 嵌入模型配置

#### 文件上传配置
- `fast-alden.file.oss.qiniu`: 七牛云存储配置
- `fast-alden.file.oss.qiniu.directories`: 按文件类型分目录配置

#### TTS 配置
- `nexusvoice.tts.token`: 七牛云 TTS API Token
- `nexusvoice.tts.voice-type`: 默认语音类型
- `nexusvoice.tts.encoding`: 音频编码格式

#### 图像生成配置
- `nexusvoice.image.siliconflow.api-key`: 硅基流动 API 密钥
- `nexusvoice.image.enabled`: 图像生成服务启用状态

#### 搜索服务配置
- `nexusvoice.search.provider`: 搜索服务提供商
- `nexusvoice.search.tavily.api-key`: Tavily 搜索 API 密钥

## 技术栈说明

- **Spring Boot 3.3.5** - 主框架
- **Java 21** - 编程语言，支持虚拟线程
- **MySQL 8.0** - 主数据库
- **MyBatis-Plus 3.5.11** - ORM 框架
- **Druid 1.2.23** - 数据库连接池和监控
- **Spring Security** - 安全框架
- **JWT (JJWT 0.12.6)** - 身份认证
- **LangChain4j 0.35.0** - AI 集成框架
- **SpringDoc OpenAPI 2.6.0** - API 文档生成
- **WebSocket** - 实时通信
- **Flyway** - 数据库版本管理

## 支持与反馈

如果在运行过程中遇到问题，请：

1. 查看日志文件获取详细错误信息
2. 检查配置文件是否正确
3. 参考故障排除章节
4. 提交 Issue 或联系开发团队

---

**注意**：请确保在生产环境中使用安全的配置，包括强密码、HTTPS 连接和适当的访问控制。
